---
title: "rs-synthesis"
date: "`r Sys.time()`"
output:
  html_document:
    df_print: paged
    toc: yes
    toc_depth: '4'
    toc_float: yes
    number_sections: true
---

```{r setup, echo = FALSE, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = FALSE)

# Load packages
library(readr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(kableExtra)
library(forcats)
library(DT)
library(metafor)
library(PerformanceAnalytics)
library(MuMIn)
library(dmetar)

theme_set(theme_minimal())

# Read in SRDB and filter out bad values using the Quality_flag column
srdb_raw <- read.csv("./rs/srdb-data.csv") %>% as_tibble()

# Read in new studies 2018-2021 that SRDB doesn't have yet
read_csv("./rs/Rs Studies 2018+ - Water Manipulation.csv",
         col_types = "cdddcdcccdcccdddddddddddc") %>% 
  select(Study_number, Record_number, Author, Study_midyear, Latitude, Ecosystem_type, 
         Manipulation, Manipulation_level, Meas_method, Soil_type,
         Rs_annual, Rh_annual, Rs_growingseason, Soil_drainage, Elevation) -> new_studies

srdb_raw %>% 
  select(Study_number, Record_number, Author, Study_midyear, Latitude, Ecosystem_type, 
         Manipulation, Manipulation_level, Meas_method, Species, Soil_type,
         Rs_annual, Rh_annual, Rs_growingseason, Soil_drainage, Soil_clay, Elevation, Quality_flag)  %>% 
  filter(!grepl("Q1[0-5]", Quality_flag)) %>% 
  bind_rows(new_studies) -> srdb

read_csv("rs/Variance and N - Water manipulations.csv", skip = 2,
         col_types = "ddcdccccdcccdddddddddddc") %>% filter(Study_number != 6066) %>% 
  select(Study_number, Record_number, N, OtherFactor, Longitude, SD_Rs_annual,	SD_Rh_annual, 
         SD_Rs_growingseason, Percent_control, SM_mean, SM_sd) %>% 
  left_join(srdb, by = c("Study_number", "Record_number")) %>% 
  mutate(SD_Rs_annual = SD_Rs_annual/378.43, #converting from g per yr to umol per s
         SD_Rh_annual = SD_Rh_annual/378.43,#this will make all final estimates comparable
         Rs_annual = Rs_annual/378.43,
         Rh_annual = Rh_annual/378.43,
    Manipulation = case_when(
    Percent_control < 100 ~ "Drought",
    Percent_control > 100 ~ "Irrigation",
    Percent_control == 100 ~ "Control",
    TRUE ~ NA_character_)) -> dat_rs
```

# Manipulation Type Summaries {.tabset .tabset-pills}

```{r filter-manipulations, message = FALSE}
# The SRDB and google sheet data have control and manipulations from the same
# study in different rows, which isn't what we want
# Rebuild the data frame to meet metafor requirements: for a given study,
# the control and treatment values are in the same row

# Construct the control data frame
# Remove duplicate control record from a study (reference respiration from pre-treatment years)
dat_rs %>% 
  filter(Manipulation == "Control", Record_number != "2368") %>% 
  select(-Record_number, -Author, -Manipulation, -Manipulation_level, -N, -SM_mean, -SM_sd)->
  controls

# Isolate the control mean and standard deviations; reshape; and join together
controls %>% 
  select(-starts_with("SD_"), -Percent_control) %>% 
  pivot_longer(cols = c(Rs_annual, Rh_annual, Rs_growingseason), 
               names_to = "depvar", values_to = "Control_Resp") ->
  cont_mean

controls %>% 
  select(-Rs_annual, -Rh_annual, -Rs_growingseason, -Percent_control) %>% 
  pivot_longer(cols = c(SD_Rs_annual, SD_Rh_annual, SD_Rs_growingseason),
               names_to = "depvar", values_to = "Control_SD") %>% 
  mutate(depvar = gsub("SD_", "", depvar)) ->
  cont_sd

meta_control <- cont_mean
meta_control$Control_SD <- cont_sd$Control_SD
meta_control <- filter(meta_control, !is.na(Control_Resp))

# and the same thing with the manipulation data frame
dat_rs %>% 
  filter(Manipulation != "Control") %>% 
  select(-starts_with("SD_")) %>% 
  pivot_longer(cols = c(Rs_annual, Rh_annual, Rs_growingseason), 
               names_to = "depvar", values_to = "Manip_Resp") ->
  manip_mean

dat_rs %>% 
  filter(Manipulation != "Control") %>% 
  select(-Rs_annual, -Rh_annual, -Rs_growingseason) %>% 
  pivot_longer(cols = c(SD_Rs_annual, SD_Rh_annual, SD_Rs_growingseason), 
               names_to = "depvar", values_to = "Manip_SD") %>% 
  mutate(depvar = gsub("SD_", "", depvar)) ->
  manip_sd

meta_manip <- manip_mean
meta_manip$Manip_SD <- manip_sd$Manip_SD
meta_manip <- filter(meta_manip, !is.na(Manip_Resp))

# Stop for a little defensive programming and qa/qc
# Every study in the manipulation data frame should have an entry in the control one
# (but the converse is not necessarily true)
sn_diff <- setdiff(meta_manip$Study_number, meta_control$Study_number)
stopifnot(length(sn_diff) == 0)

# ...and join with the manipulation data
meta_manip %>% 
  select(-Quality_flag) %>% 
  left_join(meta_control, 
            by = c("Study_number", "Study_midyear", "Ecosystem_type",
                   "Latitude", "Longitude", "OtherFactor", "Meas_method", "Species",
                   "Soil_type", "Soil_drainage", "Soil_clay", "Elevation", "depvar")) %>% 
  filter(!is.na(Manip_Resp)) %>% 
  rename("Variable" = "depvar") ->
  meta_df


#calculate study duration
meta_df %>%
  group_by(Study_number, OtherFactor, Ecosystem_type) %>%
  mutate(Duration = Study_midyear - min(Study_midyear)) -> meta_df

#How many of each type of study in each ecosystem type?
meta_df %>%
  group_by(Ecosystem_type, Manipulation) %>%
  count() -> Ecosystem_summary

#take a peak at missing data, 83 studies in dataset

#34 studies are missing elevation
meta_df %>% 
  group_by(Elevation) %>% 
  summarise(n_studies = length(unique(Study_number)), .groups = "drop") %>% 
  arrange(desc(n_studies)) %>% 
  select(Elevation, n_studies) -> Elevation_summary


#63 studies missing clay
meta_df %>% 
  group_by(Soil_clay) %>% 
  summarise(n_studies = length(unique(Study_number)), .groups = "drop") %>% 
  arrange(desc(n_studies)) %>% 
  select(Soil_clay, n_studies) -> Clay_summary
```


```{r diagnostic-plots, warning = FALSE, message = FALSE}

#compute effect sizes
metadat <- escalc(measure = "ROM",
                  m1i = Manip_Resp, m2i = Control_Resp, 
                  sd1i = Manip_SD, sd2i = Control_SD,
                  n1i = N, n2i = N, 
                  slab = paste(Study_number, Author, Study_midyear),
                  data = meta_df)

#plot distribution of effect sizes amongst different Variable types
ggplot(metadat, aes(yi, color = Manipulation)) + 
  geom_density(na.rm = TRUE) + facet_grid(Variable~., scales = "free") +
  ggtitle("Smoothed Density Estimates for Effect Sizes of Measure Variables")

#plot distribution of studies by their duration, manipulation  type, and ecosystem type
max_duration <- metadat %>%
  group_by(Study_number, Manipulation, Ecosystem_type) %>%
  summarise(max = max(Duration, na.rm = TRUE))

Manip_labs <- c("Drought" = "Decreased Precipitaiton",
                "Irrigation" = "Increased Precipitaiotn")

ggplot(max_duration) +
  geom_histogram(aes(max, fill=Ecosystem_type),
                 position = "stack", bins = 12,
                 col="black") +
  ylab("Count") +
  facet_grid(Manipulation~., labeller = as_labeller(Manip_labs)) +
  ggtitle("Few Studies Lasting > 1 yr") +
  scale_x_continuous(breaks=seq(0,max(max_duration$max), 1),
                     labels = seq(1, max(max_duration$max) +1, 1),
                     name = "Study Duration") +
  theme(legend.position = "bottom") +
  guides(fill=guide_legend("Ecosystem Type"))




```

# Prep for model run

## Check for Colinearity in potential modifiers

Ben help with getting this sorted by manipulation.
There is correlation between Duration and Latitude,
but we don't need to worry because Latitude is not
an important modifier.

```{r Autocorrelatoin_check, warning = FALSE}
#if desired seperately by the two manipualtions
#two steps using filter(Manipulation) and select(variables for correlation)
metadat[,c("Duration","Percent_control","Latitude")] %>% chart.Correlation()

```

# Increased Precipitaiton Studies
## Rank modifiers

```{r mmi_irrigation, include=FALSE, cache=TRUE}
#rank importance of modifiers for each manipulation, irrigation first
#Stick this in a separate chunk so no progress bar sullies our output
mmi_irrigation <- multimodel.inference(TE = "yi", seTE = "vi",
                     data = metadat[metadat$Manipulation == "Irrigation",],
                     predictors = c("Ecosystem_type", "Duration", "Percent_control", "Soil_drainage"),
                     interaction = TRUE)
```


```{r print mmi_irrigation}
print(mmi_irrigation$top5.models)
print(mmi_irrigation$predictor.importance.plot)
```

## Run meta-analysis

```{r irrigation}
res_irrigation <- rma.mv(yi, vi, random = ~ 1|Study_number,
              mods = ~Ecosystem_type*Duration + Soil_drainage -1,
              method = "ML",
           data = metadat,
           subset = Manipulation == "Irrigation")
summary(res_irrigation)
profile(res_irrigation)
forest.rma(res_irrigation)
funnel(res_irrigation)
plot(cooks.distance(res_irrigation), type = "o")

#Cook's Distance n/4 for irrigation studies
    length(metadat[metadat$Manipulation == "Irrigation",]$Manipulation)/4
    #Looks good!
    
# 
# #Fragile Code Ahead
# 
#     #come back to this    
#       
 Coef_irrigation <- coef(summary(res_irrigation))
# #this produces a df with coefficients, but the effect of distinct ecosystem types has to be added to the intercept (Desert) this is workable, but not optimal
# 
# #we have 5 ecosystem types
# N_ECOi <- 5
# Coef_irrigation$et_intercept <- NA
# et_entries <- grep("Ecosystem_type", row.names(Coef_irrigation))
# et_entries <- et_entries[et_entries <= N_ECOi]
# Coef_irrigation$et_intercept[et_entries] <- Coef_irrigation$estimate[et_entries] + Coef_irrigation$estimate[1]
# Coef_irrigation$et_intercept[1] <- Coef_irrigation$estimate[1]

```


# Decreased Precipitation Studies
## Rank Modifiers

```{r mmi_drought, include=FALSE, cache=TRUE}

mmi_drought <- multimodel.inference(TE = "yi", seTE = "vi",
                     data = metadat[metadat$Manipulation == "Drought",],
                     predictors = c("Ecosystem_type", "Duration", "Percent_control", "Soil_drainage"),
                     interaction = TRUE)

```

```{r print mmi_drought}
print(mmi_drought$top5.models)
print(mmi_drought$predictor.importance.plot)
```


## Run meta-analysis

```{r drought_model}
res_drought <- rma.mv(yi, vi, random = ~ 1|Study_number,
              mods = ~Ecosystem_type + Percent_control + Duration -1,
              method = "ML",
           data = metadat,
           subset = Manipulation == "Drought")
summary(res_drought)
profile(res_drought)
forest.rma(res_drought)
funnel(res_drought)
plot(cooks.distance(res_drought), type = "o")

#Cook's Distance n/4 for drought studies
    length(metadat[metadat$Manipulation == "Drought",]$Manipulation)/4
    #Looks like we might have some outliers

      
Coef_drought <- coef(summary(res_drought))
#     
# #fragile code round 2
# N_ECOd <- 6
# Coef_drought$et_intercept <- NA
# et_entries <- grep("Ecosystem_type", row.names(Coef_drought))
# et_entries <- et_entries[et_entries <= N_ECOd]
# Coef_drought$et_intercept[et_entries] <- Coef_drought$estimate[et_entries] + Coef_drought$estimate[1]
# Coef_drought$et_intercept[1] <- Coef_drought$estimate[1]
    
```

# Effect of Duration

```{r Duration_effect}
EcoTitle <- guide_legend("Ecosystem Type")

ggplot(metadat[metadat$Ecosystem_type != "Shrubland",],
       aes(Duration, yi, color=Ecosystem_type, fill = Ecosystem_type)) + 
  geom_hline(yintercept = 0)+
  geom_point(na.rm = TRUE) + geom_smooth(method = lm, aes(fill = Ecosystem_type)) +
theme(legend.position = "bottom") +
    facet_grid(.~Manipulation, labeller = as_labeller(Manip_labs)) +
  ggtitle("Effect of Study Duration SHRUBLAND NOT SHOWN") +
  scale_x_continuous(breaks=seq(0,max(metadat$Duration), 1),
                     labels = seq(1, max(metadat$Duration) +1, 1),
                     name = "Study Duration (years)") +
  guides(fill= EcoTitle, colour = EcoTitle)
```

# Effect of Intensity

```{r Intensity_effect}
ggplot(metadat,
       aes(Percent_control, yi)) + 
  geom_hline(yintercept = 0) +
  geom_point(na.rm = TRUE, aes(color = Ecosystem_type)) +
  geom_smooth(data = metadat[metadat$Manipulation == "Drought",],
              method = lm) +
  facet_grid(.~Manipulation, scales = "free") + theme(legend.position = "bottom") + ggtitle("Effect of Intensity")


```

# Effect of Ecosystem_type

```{r Ecosystem_type_effect}

lower_ci <- function(mean, se, n, conf_level = 0.95){
  lower_ci <- mean - qt(1 - ((1 - conf_level) / 2), n - 1) * se
}
upper_ci <- function(mean, se, n, conf_level = 0.95){
  upper_ci <- mean + qt(1 - ((1 - conf_level) / 2), n - 1) * se
}

ggplot(Coef_drought, aes(estimate,
                         row.names(Coef_drought),
                         na.rm = TRUE)) + 
  geom_vline(xintercept = 0) +
  geom_errorbarh(aes(xmax = estimate + se,
                     xmin = estimate - se,
                     na.rm = TRUE)) +
  geom_point(size = 4, na.rm = TRUE)

ggplot(Coef_irrigation, aes(estimate,
                         row.names(Coef_irrigation),
                         na.rm = TRUE)) + 
  geom_vline(xintercept = 0) +
  geom_errorbarh(aes(xmax = estimate + se,
                     xmin = estimate - se,
                     na.rm = TRUE)) +
  geom_point(size = 4, na.rm = TRUE)
  
metadat %>%
  group_by(Manipulation, Ecosystem_type) %>%
  summarise(average = mean(yi, na.rm = TRUE),
            ssd = sd(yi, na.rm = TRUE),
            count = n()) %>%
  mutate(se = ssd/sqrt(count),
         lower_ci = lower_ci(average, se, count),
         upper_ci = upper_ci(average, se, count))-> Ecosystem_effect

ggplot(Ecosystem_effect, aes(average, Ecosystem_type, label = count)) + 
  geom_vline(xintercept = 0) +
  geom_errorbarh(aes(xmax = upper_ci, xmin = lower_ci,
                     na.rm = TRUE)) +
  geom_point(size = 4, na.rm = TRUE) + 
  facet_grid(.~Manipulation) + geom_label()
    
#Want to make a graph using the effect sizes, how to do that?
#Use Coef_irrigation
```


# The End

```{r}
sessionInfo()
```

