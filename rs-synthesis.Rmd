
---
title: "rs-synthesis"
author: "Kendalynn Morris"
date: "`r Sys.time()`"
output:
  bookdown::html_document2:
    fig_caption: yes
    number_sections: yes
    df_print: paged
    toc: yes
    toc_depth: '4'
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: '4'
---

```{r setup, echo = FALSE, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = FALSE)


# Load packages
# raster needs to come before dplyr load so 'select' isn't masked; we use `require`
# because only need it if the geotiffs are available (and not on GitHub Actions)
require(raster)
# Normal package loads
library(readr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(ggExtra)
library(kableExtra)
library(forcats)
library(DT)
library(metafor)
library(PerformanceAnalytics)
library(MuMIn)
if(packageVersion("MuMIn") > "1.43.15") {
stop("This analysis won't work with newer versions of MuMIn; please install 1.43.15",
     '\ndevtools::install_version("MuMIn", version = "1.43.15", repos = "http://cran.us.r-project.org")')
}
library(dmetar)
library(broom)
library(bookdown)
library(ggmap)
library(rnaturalearth)
library(rnaturalearthdata)
library(ggspatial)
library(sf)
library(ggpmisc)

theme_set(theme_minimal() + theme(text = element_text(size = 16)))

# 'Pretty n' function to round a numeric value and print that # of digits
pn <- function(x, n) {
  formatC(round(unlist(x), n),
          digits = n, format = "f")
}

# 'Clean p value' function to pretty-print p value(s), specifically
pclean <- function(x, digits = 3, printP = TRUE) {
  x <- as.vector(x)
  ltstring <- paste0("< 0.", paste(rep("0", digits - 1), 
                                   collapse = ""), "1")
  valstring <- ifelse(x < 10 ^ -digits, 
                      ltstring, pn(x, digits))
  if(printP) {
    paste("P", ifelse(x < 10 ^ -digits, 
                      valstring, paste("=", valstring)))
  } else {
    valstring
  }
}

# Read in SRDB and filter out bad values using the Quality_flag column
srdb_raw <- read.csv("./rs/srdb-data.csv") %>% as_tibble()

# Read in new studies 2018-2021 that SRDB doesn't have yet
read_csv("./rs/Rs Studies 2018+ - Water Manipulation.csv",
         col_types = "cdddcdcccdcccdddddddddddc"
) %>%
  select(
    Study_number, Record_number, Author, Study_midyear, Latitude, Ecosystem_type,
    Manipulation, Manipulation_level, Meas_method, Soil_type,
    Rs_annual, Rh_annual, Rs_growingseason, Elevation
  ) -> new_studies

srdb_raw %>%
  select(
    Study_number, Record_number, Author, Study_midyear, Latitude, Ecosystem_type,
    Manipulation, Manipulation_level, Meas_method, Species, Soil_type,
    Rs_annual, Rh_annual, Rs_growingseason, Elevation, Meas_interval, Quality_flag
  ) %>%
  filter(!grepl("Q1[0-5]", Quality_flag)) %>%
  bind_rows(new_studies) -> srdb

# Read in main meta-analysis data: Rs variance and N for water manipulations
read_csv("rs/Variance and N - Water manipulations.csv",
         col_types = "ddcdcccddddddccddcccdddddddddddc",
) %>% #remove study manipulating timing of precipitation (6066)
  filter(!Study_number %in% c(6066, 13000, 13112)) %>% # remove duplicates (13000 & 13112)
  select(
    Study_number, Record_number, N, OtherFactor, Longitude, Clay_percent,
    Clay_depth, SOC_percent, SOC_depth, SM_percent, SM_depth, BBL_notes,
    SD_Rs_annual, SD_Rh_annual, SD_Rs_growingseason,
    Percent_control, SM_mean, SM_sd
  ) %>%
  left_join(srdb, by = c("Study_number", "Record_number")) %>%
  mutate(
    SD_Rs_annual = SD_Rs_annual / 378.43, # converting from g per yr to Âµmol per s
    SD_Rh_annual = SD_Rh_annual / 378.43, # this will make all final estimates comparable
    Rs_annual = Rs_annual / 378.43,
    Rh_annual = Rh_annual / 378.43,
    Manipulation = case_when(
      Percent_control < 100 ~ "Drought",
      Percent_control > 100 ~ "Irrigation",
      Percent_control == 100 ~ "Control",
      TRUE ~ NA_character_
    )
  ) -> dat_rs
```


```{r filter-manipulations, message = FALSE, warning = FALSE, echo = FALSE}
# The SRDB and google sheet data have control and manipulations from the same
# study in different rows, which isn't what we want
# Rebuild the data frame to meet metafor requirements: for a given study,
# the control and treatment values are in the same row

# Construct the control data frame
# Remove duplicate control record from a study (reference respiration from pre-treatment years)
dat_rs %>%
  filter(Manipulation == "Control", Record_number != "2368") %>%
  select(-Record_number, -Author, -Manipulation, -Manipulation_level, -N, -SM_mean, -SM_sd) %>%
  rename("contSM_per" = "SM_percent",
         "contSM_depth" = "SM_depth") ->
  controls

# Isolate the control mean and standard deviations; reshape; and join together
controls %>%
  select(-starts_with("SD_"), -Percent_control) %>%
  pivot_longer(
    cols = c(Rs_annual, Rh_annual, Rs_growingseason),
    names_to = "depvar", values_to = "Control_Resp"
  ) ->
  cont_mean

controls %>%
  select(-Rs_annual, -Rh_annual, -Rs_growingseason, -Percent_control) %>%
  pivot_longer(
    cols = c(SD_Rs_annual, SD_Rh_annual, SD_Rs_growingseason),
    names_to = "depvar", values_to = "Control_SD"
  ) %>%
  mutate(depvar = gsub("SD_", "", depvar)) ->
  cont_sd

meta_control <- cont_mean
meta_control$Control_SD <- cont_sd$Control_SD
meta_control <- filter(meta_control, !is.na(Control_Resp))

# and the same thing with the manipulation data frame
dat_rs %>%
  filter(Manipulation != "Control") %>%
  select(-starts_with("SD_")) %>%
  pivot_longer(
    cols = c(Rs_annual, Rh_annual, Rs_growingseason),
    names_to = "depvar", values_to = "Manip_Resp"
  ) ->
  manip_mean

dat_rs %>%
  filter(Manipulation != "Control") %>%
  select(-Rs_annual, -Rh_annual, -Rs_growingseason) %>%
  pivot_longer(
    cols = c(SD_Rs_annual, SD_Rh_annual, SD_Rs_growingseason),
    names_to = "depvar", values_to = "Manip_SD"
  ) %>%
  mutate(depvar = gsub("SD_", "", depvar)) ->
  manip_sd

meta_manip <- manip_mean
meta_manip$Manip_SD <- manip_sd$Manip_SD
meta_manip <- filter(meta_manip, !is.na(Manip_Resp))

# Stop for a little defensive programming and qa/qc
# Every study in the manipulation data frame should have an entry in the control one
# (but the converse is not necessarily true)
sn_diff <- setdiff(meta_manip$Study_number, meta_control$Study_number)
stopifnot(length(sn_diff) == 0)

# ...and join with the manipulation data
meta_manip %>%
  select(-Quality_flag) %>%
  left_join(meta_control,
            by = c(
              "Study_number", "Study_midyear", "Ecosystem_type",
              "Latitude", "Longitude", "OtherFactor", "Meas_method",
              "Species", "Soil_type", "Clay_percent", "Clay_depth",
              "SOC_percent", "SOC_depth", "Meas_interval",
              "BBL_notes", "Elevation", "depvar"
            )
  ) %>%
  filter(!is.na(Manip_Resp)) %>%
  rename("Variable" = "depvar",
         "manipSM_per" = "SM_percent",
         "manipSM_depth" = "SM_depth") -> meta_df

# calculate study duration
meta_df %>%
  group_by(Study_number, OtherFactor, Ecosystem_type) %>%
  mutate(Duration = Study_midyear - min(Study_midyear)) -> meta_df

# sort ecosystem types by water-limitation
meta_df$Ecosystem_type <- factor(meta_df$Ecosystem_type,
                                 levels = c(
                                   "Wetland", "Forest", "Shrubland",
                                   "Savanna", "Grassland", "Desert"
                                 )
)

# and set-up a max duration dataframe for graphing down the line
max_duration <- meta_df %>%
  group_by(Study_number, Manipulation, Ecosystem_type) %>%
  summarise(max = max(Duration, na.rm = TRUE))

```

# Study table

Summary of the studies included in this meta-analysis:

```{r studies-table}
read_csv("rs/srdb-studies.csv", 
         col_types = "iccccccciccccccicccccciic") %>% 
  select(Study_number, Authors, Title, Source) ->
  studies

# Three studies are missing DOIs in the SRDB data
# Opened an issue to correct: https://github.com/bpbond/srdb/issues/133
studies[studies$Study_number == 1268, "DOI"] <- "10.1139/x98-145"
studies[studies$Study_number == 1421, "DOI"] <- "10.2136/sssaj1999.6361848x"
studies[studies$Study_number == 1639, "DOI"] <- "10.1139/x99-218"
# Note that a fourth (7593 Wang) has no DOI at all, according to Scopus 

#Possible frame shift in SRDB study numbers
#Opened an issue to correct: https://github.com/bpbond/srdb/issues/135
#hDOI's confirmed for 80 studies included
read_csv("rs/DOIcheck.csv",
         col_types = "iici") -> ConfirmedDOI

meta_df %>% 
  group_by(Study_number, Ecosystem_type, Manipulation, Author) %>% 
  summarise(Observations = n(), .groups = "drop") %>% 
  left_join(ConfirmedDOI, by = "Study_number") %>% 
  mutate(Author = gsub(",.*$", "", Author),
         Author = paste0(Author, " et al. (", PubYear, ")")) %>% 
  arrange(PubYear) %>% 
  select(ID = Study_number, Author, DOI, Observations, Ecosystem_type, Manipulation) %>% 
  pivot_wider(names_from = "Manipulation", values_from = "Observations", values_fill = 0) %>% 
  group_by(ID, Author, DOI) %>% 
  summarise(Ecosystem_type = paste(unique(Ecosystem_type), collapse = ", "),
            Drought = sum(Drought), Irrigation = sum(Irrigation),
            .groups = "drop") %>%  
  knitr::kable(caption = "  Table 1. Studies included in this dataset.") %>% 
  kable_paper("striped")
```
## Data Summaries  
\
Within SRDB there were `r length(unique(meta_df$Study_number))` studies that matched our search criteria. These included six distinct ecosystem types; wetland, forest, shrubland, savanna, grassland, and desert. Forest and grassland ecosystems, by far the most common ecosystem types in the dataset, were represented by `r length(unique(meta_df[meta_df$Ecosystem_type == "Forest",]$Study_number))` and length(unique(meta_df[meta_df$Ecosystem_type == "Grassland",]$Study_number)) studies respectively. `r length(unique(meta_df[meta_df$Ecosystem_type == "Shrubland",]$Study_number))` studies contributed data on shrublands, `r length(unique(meta_df[meta_df$Ecosystem_type == "Desert",]$Study_number))` on deserts, `r length(unique(meta_df[meta_df$Ecosystem_type == "Savanna",]$Study_number))` on savannas, and `r length(unique(meta_df[meta_df$Ecosystem_type == "Wetland",]$Study_number))` on wetlands. Many studies contained both increased and decreased precipitation manipulations and the number of studies and effect sizes per ecosystem and manipulation type are summarized in Table 2.  
\
\

```{r study-map, echo = FALSE}
# Extract coordinates and useful columns, remove any duplicate coordinates
meta_df %>% 
  ungroup() %>% 
  select(Study_number, Latitude, Longitude, Ecosystem_type) %>% 
  distinct(Study_number, Latitude, Longitude, .keep_all = TRUE) -> meta_coords

world <- ne_countries(scale = "medium", returnclass = "sf")
Eco_colors <- c("#01665e","#5ab4ac","#c7eae5","#f6e8c3","#d8b365","#8c510a")

ggplot(data = world) +
     geom_sf(lwd = 0.1, fill = "white") +
  coord_sf(expand = FALSE) +
  geom_point(data = meta_coords, aes(x = Longitude, y = Latitude, fill = Ecosystem_type), pch =  21, size = 2) +
  theme(panel.grid.major = element_blank(),
        panel.background = element_rect(fill = "lightskyblue2"),
        panel.grid.minor = element_blank(),
        legend.position = "bottom",
        axis.title.y = element_blank(),
        axis.title.x = element_blank()) +
    labs(fill = "Ecosystem") +
  scale_fill_manual(values = Eco_colors)

```


```{r Studies_EffectSizes, echo = FALSE}
#By Ecosystem and Manipulation
#summarize the number of effect size pairs
#and the number of studies they came from
meta_df %>%
  group_by(Manipulation, Ecosystem_type) %>%
  count() %>%
  pivot_wider(
    names_from = Manipulation,
    values_from = n
  ) -> EffectSizePairs
g
meta_df %>%
  group_by(Manipulation, Ecosystem_type) %>%
  summarise(n_studies = length(unique(Study_number)), .groups = "drop") %>%
  pivot_wider(
    names_from = Manipulation,
    values_from = n_studies
  ) -> Ecosystem_studies

EffectSizePairs %>%
  left_join(Ecosystem_studies, by = "Ecosystem_type") -> EES_table

EES_table %>%
  kable(
    caption = "  Table 2. Studies and Effect Sizes per Ecosystem and Manipulation",
    col.names = c("Ecosystem", " -P ", " +P ", " -P ", " +P ")
  ) %>%
  add_header_above(c("    " = 1, " Effect Sizes " = 2, " Studies " = 2))
```


```{r soilgrids, message = FALSE, warning = FALSE, echo = FALSE}
# Extract clay and organic carbon storage values from global Soilgrids datasets

# If we have pre-saved extracted data, use that, because this is a very slow step
clay_ex_data <- "soilgrids/clay_data.RDS"
ocs_ex_data <- "soilgrids/ocs_data.RDS"
if(file.exists(clay_ex_data) && file.exists(ocs_ex_data)) {
  x_clay <- readRDS(clay_ex_data)
  x_ocs <- readRDS(ocs_ex_data)
  if(length(x_clay) != nrow(meta_df)) {
    stop("Clay/OCS extracted data are out of date; please delete (in soilgrids folder) and re-run")
  }
 meta_df$sg_clay <- x_clay 
  meta_df$sg_ocs <- x_ocs
} else {
  # No extracted data available; need to re-extract (a slow step)
  clayfile <- "./soilgrids/clay_15-30cm_mean.tif"
  ocsfile <- "./soilgrids/ocs_0-30cm_mean.tif"
  if (file.exists(clayfile) && file.exists(ocsfile)) {
    clay <- raster(clayfile)
    meta_points <- SpatialPoints(meta_df[c("Longitude", "Latitude")],
                                 proj4string = CRS("+proj=longlat +datum=WGS84")
    )
    # Reproject our long-lat points to the UTM used by the geoTIFF
    meta_points <- spTransform(meta_points, projection(clay))
    # ...and extract the values we want, averaging nearest 1000m
    meta_df$sg_clay <- raster::extract(clay, meta_points, buffer = 1000, fun = mean)
    
    # Second file, same operation
    ocs <- raster(ocsfile)
    meta_df$sg_ocs <- raster::extract(ocs, meta_points, buffer = 1000, fun = mean)
  } else {
    stop("Neither geoTIFF files nor pre-extracted soilgrids data are present!")
  }
}
```
h
```{r Soil_content_supplement, message = FALSE, warning = FALSE, echo = FALSE}
meta_df %>%
  select(Study_number, Clay_percent, Clay_depth,
         SOC_percent, SOC_depth, BBL_notes,
         Ecosystem_type, sg_clay, sg_ocs
         ) -> soil_content

#Soil grids vs study reported organic carbon stock
#assuming bulk density of 1.5 g/cm^3
 ggplot(data = soil_content) +
  geom_point(aes(SOC_percent, sg_ocs/100*1/SOC_depth/1.5*100,
             colour = Ecosystem_type),
             size = 3) +
  scale_color_manual(name = "Ecosystem",
                     values = Eco_colors) +
  labs(x = "Study OCS",
       y = "SoilGrids OCS") +
  geom_abline(intercept = 0, slope = 1)

#Soil grids (15 - 30 cm) vs study reported soil clay content
#ignoring differences in soil depth (see Clay_depth for comparison of depths)
ggplot(data = soil_content) +
  geom_point(aes(Clay_percent, sg_clay/10,
             colour = Ecosystem_type),
             size = 3) +
  scale_color_manual(name = "Ecosystem",
                     values = Eco_colors) +
  labs(x = "Study %Clay",
       y = "SoilGrids %Clay") +
  geom_abline(intercept = 0, slope = 1)

```
# Summary Plots

```{r diagnostic-plots, fig.cap = "Few studies lasting >1 year", warning = FALSE, message = FALSE, echo = FALSE}

# compute effect sizes using log response ratio
metadat <- escalc(
  measure = "ROM",
  m1i = Manip_Resp, m2i = Control_Resp,
  sd1i = Manip_SD, sd2i = Control_SD,
  n1i = N, n2i = N,
  slab = paste(Study_number, Author, Study_midyear),
  data = meta_df
)

VarLabs <- c(
  "Rh_annual" = "Microbial Annual",
  "Rs_annual" = "Annual",
  "Rs_growingseason" = "Growing Season"
)

Manip_labs <- c(
  "Drought" = "-P",
  "Irrigation" = "+P"
)

# histogram of study duration among ecosystem types
ggplot(max_duration) +
  geom_histogram(aes(max, fill = Manipulation),
                 position = "stack", bins = 13,
                 col = "black", size = 0.5
  ) +
  scale_fill_discrete(label = Manip_labs) +
  ylab("Count") +
    scale_x_continuous(
    breaks = seq(0, max(max_duration$max), 1),
    labels = seq(1, max(max_duration$max) + 1, 1),
    name = "Study Duration (yrs)"
  ) +
  theme(legend.position = "bottom")
```
```{r var_dist, echo = FALSE}
ggplot(metadat, aes(yi, color = Manipulation)) +
  xlab("ln(Response Ratio)") +
  geom_density(na.rm = TRUE) +
  facet_grid(Variable~., scales = "free", labeller = labeller(Variable = VarLabs)) +
  ggtitle("Distribution of Data")

```

```{r dependentVars, echo = FALSE, include = FALSE}
#irrigation studies
metadat_imodel_var <- rma.mv(yi, vi,
                             random = ~ 1 | Study_number,
                             mods = ~ Variable - 1,
                             method = "REML",
                             data = metadat[metadat$Manipulation == "Irrigation",],
                             slab = Variable,
)
summary(metadat_imodel_var)
Coef_ivar <- coef(summary(metadat_imodel_var))

#drought studies
metadat_dmodel_var <- rma.mv(yi, vi,
                         random = ~ 1 | Study_number,
                         mods = ~ Variable - 1,
                         method = "REML",
                         data = metadat[metadat$Manipulation == "Drought",],
                         slab = Variable,
)
summary(metadat_dmodel_var)
Coef_dvar <- coef(summary(metadat_dmodel_var))

```

```{r dependentVars_graphs, echo = FALSE}
#plyr::count(metadat[metadat$Manipulation == "Irrigation",]$Variable)
Vari_ss <- c("6", "77", "58")
Forestivar <- forest(Coef_ivar$estimate,
                  ci.lb = Coef_ivar$ci.lb,
                  ci.ub = Coef_ivar$ci.ub,
                  annotate = TRUE,
                  slab = c(
                    "Rh_annual", "Rs_annual",
                    "Rs_growingseason"
                  ),
                  xlim = c(-0.18, 0.5),
                  cex = 1,
                  cex.lab = 1,
                  cex.main = 2,
                  digits = 2,
                  lwd = 2
)
text(0.05, rev(seq(3:1)), Vari_ss)
op <- par(cex=1, font=2)
text(-.089, 4.2, "Dependent Variable")
text(.05, 4.2, "Sample Size")
text(.42, 4.2, "ln(RR) [95% CI]")
text(0.1, 5, "Dependent Variables for Irrigaiton Studies")

#plyr::count(metadat[metadat$Manipulation == "Drought",]$Variable)
Vard_ss <- c("11", "82", "35")
Forestdvar <- forest(Coef_dvar$estimate,
                     ci.lb = Coef_dvar$ci.lb,
                     ci.ub = Coef_dvar$ci.ub,
                     annotate = TRUE,
                     slab = c(
                       "Rh_annual", "Rs_annual",
                       "Rs_growingseason"
                     ),
                     cex = 1,
                     cex.lab = 1,
                     cex.main = 2,
                     digits = 2,
                     lwd = 2
)
text(-.28, rev(seq(3:1)), Vard_ss)
op <- par(cex=1, font=2)
text(-.47, 4.2, "Dependent Variable")
text(-.28, 4.2, "Sample Size")
text(.2, 4.4, "ln(RR) [95% CI]")
text(-0.12, 5, "Dependent Variables for Drought Studies")
```

```{r in_textVals, include = FALSE}
#studies lasting only one year
ss <- length(unique(max_duration[max_duration$max == "0",]$Study_number))
#studies longer than two years
ls <- length(unique(max_duration[max_duration$max > "1",]$Study_number))
#all studies
all <- length(unique(meta_df$Study_number))

```

```{r dist_manip, fig.cap = " Distribution of manipulations, dashed red line indicates break between -P and +P treatments", warning = FALSE, message = FALSE, echo = FALSE}

# plot distribution of percent_control among different Variable types

ggplot(metadat, aes(Percent_control, fill = Ecosystem_type)) +
  xlab("Percent of MAP") +
  geom_histogram(
    na.rm = TRUE,
    position = "stack",
    col = "black", size = 0.5,
    bins = 10
  ) +
  facet_grid(. ~ Manipulation,
             scales = "free",
             labeller = as_labeller(Manip_labs)) +
  ylab("Count") +  
  scale_fill_manual(name = "Ecosystem", values = Eco_colors ) +
  theme(legend.position = "bottom")
```

\
\
Study sites were distributed across the terrestrial biosphere, but coverage was better in the global north. Distribution of effect sizes in both models indicated little influence of publication bias. The majority of studies lasted only one year (`r ss` of `r all`) and only `r as.numeric(pn(ls/all, 2))*100`% (`r ls` of `r all`) were longer than two years (Figure \autoref(fig:diagnostic-plots)). Manipulation intensity (how much a study increased or decreased precipitation) was not evenly distributed among ecosystems (Figure \autoref(fig:dist_manip)). Manipulated precipitation ranged from `r min(meta_df$Percent_control)`% to `r signif(max(meta_df$Percent_control), 3)`% of MAP, with a mean of `r signif(mean(meta_df[meta_df$Manipulation == "Irrigation",]$Percent_control), 3)`% of MAP for increased precipitation studies, and `r signif(mean(meta_df[meta_df$Manipulation == "Drought",]$Percent_control), 2)`% of MAP for decreased precipitation studies.  
\
\
```{r Autocorrelation_check, include = FALSE}
# if desired separately by the two manipulations
# two steps using filter(Manipulation) and select(variables for correlation)
metadat[, c("Duration", "Percent_control", "Latitude", "sg_clay", "sg_ocs", "Meas_interval")] %>% chart.Correlation()
```

# Ecosystem Effects    
## Increased Precipitation

```{r mmi_irrigation, include=FALSE, cache=TRUE}
# rank importance of modifiers for each manipulation, irrigation first
# Stick this in a separate chunk so no progress bar sullies our output
mmi_irrigation <- multimodel.inference(
  TE = "yi", seTE = "vi",
  data = metadat[metadat$Manipulation == "Irrigation", ],
  predictors = c("Ecosystem_type", "Duration", "Percent_control", "sg_ocs"),
  interaction = TRUE
)

# here sg_clay is excluded to allow for interactions after seeing that it had very low estimated importance in a none-interactive model
```

```{r print mmi_irrigation, include = FALSE}
# print(mmi_irrigation$top5.models)
print(mmi_irrigation$predictor.importance.plot)
# soil organic carbon, ecosystem, and duration (as well as ecosystem x duration) are all highly important
```
\
\
For +P studies, the primary effect of SOC, ecosystem type, study duration, and the interaction between ecosystem type and duration were the four highest ranked preictors. In contrast, the -P model ranked ecosystem type, SOC, clay, and duration as the top four predictors.
\
\
```{r irrigation, include = FALSE}
#create of subset of metadat which only includes our model inputs
metadat %>%
  filter(Manipulation == "Irrigation") %>%
  select("Study_number", "Ecosystem_type",
         "Meas_interval", "Duration",
         "sg_ocs", "yi", "vi") -> metadat_i#%>% commenting out this na.omit for now
  #na.omit() -> metadat_i

# rma.mv conducts a meta-analysis multivariate mixed effects model
# the - 1 for the fixed effect modifiers gives us estimates for individual ecosystem types
metadat_imodel <- rma.mv(yi, vi,
                         random = ~ 1 | Study_number,
                         mods = ~ Ecosystem_type * Duration + Meas_interval + sg_ocs - 1,
                         method = "REML",
                         data = metadat_i,
                         slab = Ecosystem_type,
)

summary(metadat_imodel)
ip <- tidy(metadat_imodel)
desert_p <- ip$p.value[ip$term == "Ecosystem_typeDesert"]
ocs_ip <- ip$p.value[ip$term == "sg_ocs"]
ipreds <- predict.rma(metadat_imodel)
profile(metadat_imodel)
forest.rma(metadat_imodel)
funnel(metadat_imodel)
plot(cooks.distance(metadat_imodel), type = "o")

# Cook's Distance n/4 for irrigation studies
length(metadat[metadat$Manipulation == "Irrigation", ]$Manipulation) / 4
# Looks good!

Coef_irrigation <- coef(summary(metadat_imodel))
```

```{r +P_forest, fig.cap = " Ecosystem effect for increased precipitation manipulations."}  
# Forest plot for Irrigation studies

# plyr::count(metadat[metadat$Manipulation == "Irrigation",]$Ecosystem_type)
Ecoi_ss <- c("36", "5", "7", "80", "13")

Foresti <- forest(100 * (exp(Coef_irrigation[1:5, ]$estimate) - 1),
                  ci.lb = 100 * (exp(Coef_irrigation[1:5, ]$ci.lb) - 1),
                  ci.ub = 100 * (exp(Coef_irrigation[1:5, ]$ci.ub) - 1),
                  annotate = TRUE,
                  xlab = "Percent Change in Soil Respiration",
                  slab = c(
                    "Forest", "Shrubland",
                    "Savanna", "Grassland", "Desert"
                  ),
                  cex = 1,
                  cex.lab = 1,
                  cex.main = 2,
                  digits = 1,
                  lwd = 2
)

# Code to write sample size of sub-groups on graph
# For this code, enter x-position of text, then y-position. You may have to experiment a bit.
text(-20, rev(seq(5:1)), Ecoi_ss)
# Set up font for rest of graph (just the headers of the graph remain), to make bold headings, set font=2
op <- par(cex = 1, font = 2)
text(-80, 6.25, "Ecosystem")
text(-20, 6.25, "Sample Size")
text(100, 6.25, "Mean [95% CI]")

```
\
\
While in general soil respiration rates were greater with increased precipitation, only desert ecosystems showed a statistically significant increase (`r pclean(desert_p)`, Figure \autoref(fig:+P_forest)). There was a significant interaction between the duration of studies and the strength and direction of the respiration response in forest, grassland, and desert ecosystems (Figure \autoref(fig:Duration_effect_+P). The initial increase in soil respiration changed over time, decreasing strongly in forests, while increasing slightly in grasslands and strongly in deserts.  
\
\

## Decreased Precipitation

```{r mmi_drought, include=FALSE, cache=TRUE}

mmi_drought <- multimodel.inference(
  TE = "yi", seTE = "vi",
  data = metadat[metadat$Manipulation == "Drought", ],
  predictors = c("Ecosystem_type", "sg_ocs", "sg_clay", "Percent_control", "Duration"),
  interaction = TRUE
)
# interactions cannot be calculated because we are using 5 factors
```

```{r print mmi_drought, include=FALSE}
# print(mmi_drought$top5.models)
print(mmi_drought$predictor.importance.plot)
# ecosystem, soil organic carbon, clay, and percent_control are all highly important
```

```{r drought_model, include=FALSE}
metadat %>%
  filter(Manipulation == "Drought") %>%
  select("Study_number", "Ecosystem_type",
         "Duration", "Percent_control",
         "Meas_interval",
         "sg_clay", "sg_ocs",
         "yi", "vi") -> metadat_d #%>% commenting out this na.omit for now
  #na.omit() -> metadat_d

metadat_dmodel <- rma.mv(yi, vi,
                         random = ~ 1 | Study_number,
                         mods = ~ Ecosystem_type + sg_clay + sg_ocs + Percent_control + Meas_interval - 1,
                         method = "REML",
                         data = metadat_d,
                         slab = Ecosystem_type,
)

summary(metadat_dmodel)
dp <- tidy(metadat_dmodel)
ocs_dp <- dp$p.value[dp$term == "sg_ocs"]
clay_dp <- dp$p.value[dp$term == "sg_clay"]
profile(metadat_dmodel)
forest.rma(metadat_dmodel)
funnel(metadat_dmodel)
plot(cooks.distance(metadat_dmodel), type = "o")

dpreds <- predict.rma(metadat_dmodel)

#combine columns into one dataframe
metadat_d %>%
  bind_cols(as.data.frame(dpreds)) -> metadat_dpreds

# Cook's Distance n/4 for drought studies
length(metadat[metadat$Manipulation == "Drought", ]$Manipulation) / 4
#One study (13079) has a strong influence
#4 years of data for grassland and desert

Coef_drought <- coef(summary(metadat_dmodel))
```

```{r -P_forest, fig.cap = " Ecosystem effect for decreased precipitation manipulations."}

# Forest plot for Drought studies

# plyr::count(metadat[metadat$Manipulation == "Drought",]$Ecosystem_type)
Ecod_ss <- c("2", "38", "27", "1", "53", "7")

Forestd <- forest(100 * (exp(Coef_drought[1:6, ]$estimate) - 1),
                  ci.lb = 100 * (exp(Coef_drought[1:6, ]$ci.lb) - 1),
                  ci.ub = 100 * (exp(Coef_drought[1:6, ]$ci.ub) - 1),
                  annotate = TRUE,
                  xlab = "Percent Change in Soil Respiration",
                  slab = c(
                    "Wetland", "Forest", "Shrubland",
                    "Savanna", "Grassland", "Desert"
                  ),
                  cex = 1,
                  cex.lab = 1,
                  cex.main = 2,
                  digits = 1,
                  lwd = 2
)

text(-100, rev(seq(6:1)), Ecod_ss)
op <- par(cex = 1, font = 2)
text(-180, 7.3, "Ecosystem")
text(-100, 7.3, "Sample Size")
text(100, 7.3, "Mean [95% CI]")

```

\
\
In contrast, when precipitation was decreased, soil respiration rates were lower relative to control rates (Figure \autoref(fig:-P_forest). Wetlands were an exception and showed elevated soil respiration rates although this effect was not significant.  
\
\

# Effect of Duration
## Increased Precipitation
```{r Duration_effect_+P, fig.cap = " Duration +P studies", echo = FALSE, warning = FALSE, message = FALSE}
EcoTitle <- guide_legend("Ecosystem Type")

#combine columns into one dataframe
metadat_i %>%
  bind_cols(as.data.frame(ipreds)) -> metadat_ipreds

#plot using linear predictions from model
ggplot(
  data = metadat_ipreds,
  aes(Duration, pred)) +
  geom_hline(yintercept = 0) +
  geom_point(aes(fill = Ecosystem_type, colour = Ecosystem_type), size = 3) +
  geom_smooth(method = lm, formula = y ~ x, aes(fill = Ecosystem_type, color = Ecosystem_type)) +
  ylab("predicted ln(RR)") +
  scale_x_continuous(
    breaks = seq(0, max(metadat$Duration), 1),
    labels = seq(1, max(metadat$Duration) + 1, 1),
    name = "Study Duration (yrs)"
  ) +
  scale_color_manual(name = "Ecosystem", values = Eco_colors) +
  scale_fill_manual(name = "Ecosystem", values = Eco_colors) +
  theme(legend.position = "bottom") +
  guides(fill = guide_legend(ncol = 3))


```


```{r TEMPEST, fig.cap = "Prediction of TEMPEST treatment effects on soil respiration", include = FALSE}
### Tempest
metadat %>%
  filter(Manipulation == "Irrigation") %>%
  select("Study_number", "Ecosystem_type",
         "Duration", "Percent_control", "sg_ocs", "yi",
         "vi") %>%
  na.omit() -> metadat_i2

# rma.mv conducts a meta-analysis multivariate mixed effects model
# the - 1 for the fixed effect modifiers gives us estimates for individual ecosystem types
metadat_imodel2 <- rma.mv(yi, vi,
                          random = ~ 1 | Study_number,
                          mods = ~ Ecosystem_type * Duration + Percent_control + sg_ocs - 1,
                          method = "REML",
                          data = metadat_i2,
                          slab = Ecosystem_type,
)
summary(metadat_imodel2)
ip2 <- tidy(metadat_imodel2)
ipreds2 <- predict.rma(metadat_imodel2)

#combine columns into one dataframe
metadat_i2 %>%
  bind_cols(as.data.frame(ipreds2)) -> metadat_ipreds2

predRes <- list()

for (pc in c(116, 132, 148)) {
  for (dur in 0:3){
    test_predict <- predict(metadat_imodel2,
                            newmods = c(Ecosystem_typeForest = 1,
                                      Ecosystem_typeSavanna = 0,
                                      Ecosystem_typeShrubland = 0,
                                      Ecosystem_typeGrassland = 0,
                                      Ecosystem_typeDesert = 0, 
                                      Duration = dur,
                                      Percent_control = pc, 
                                      sg_ocs = 45,
                                      `Ecosystem_typeGrassland:Duration` = 0,
                                      `Ecosystem_typeForest:Duration` = dur))
    result <- as_tibble(test_predict)
    result$Duration <- dur
    result$Percent_control <- pc
    predRes[[paste(dur, pc)]] <- result
  }
}

temp_est2 <- bind_rows(predRes)
temp_est2$Flood_number <- (temp_est2$Percent_control - 100) / 16


ggplot(
  data = temp_est2,
  aes(Duration+1, 100 * (10 ^ pred -1),
      group = as.factor(Flood_number))) +
  geom_hline(yintercept = 0) +
  geom_point(aes(fill = as.factor(Flood_number),
                 colour = as.factor(Flood_number),
                 size = 0.5)) +
  geom_line(aes(fill = as.factor(Flood_number),
                colour = as.factor(Flood_number)),
                size = 0.75) +
  geom_ribbon(aes(ymin=(100*(10^pred - 1) - (100*(10^se -1))),
                  ymax=(100*(10^pred - 1) + (100*(10^se -1))),
                  fill = as.factor(Flood_number)),
              alpha = 0.2) +
  ylab("predicted \n %Change Soil Respiration") +
  xlab("Study Duration (years)") +
  scale_color_manual(name = "Number of Flood Events",
    values = c("sienna1", "sienna4","hotpink4")
  ) +
  scale_fill_manual(name = "Number of Flood Events",
       values = c("sienna1", "sienna4","hotpink4")
  ) +
  ggtitle("Predicted response of soil respiration in TEMPEST") +
  guides(size = "none") +
  theme(legend.position = "bottom")


```

## Decreased Precipitation

```{r Supplement_-P_duration_plot, fig.cap = " Supplmental Figure", message = FALSE, warning = FALSE}
#supplemental figure, the -P version of the +P vs Duration Plot
#run a secondary rma.mv 
metadat_dmodel2 <- rma.mv(yi, vi,
                          random = ~ 1 | Study_number,
                          mods = ~ Ecosystem_type * Duration + sg_ocs - 1,
                          method = "REML",
                          data = metadat_d,
                          slab = Ecosystem_type,
)

d2preds <- predict.rma(metadat_dmodel2)

#combine columns into one dataframe
metadat_d %>%
  bind_cols(as.data.frame(d2preds)) -> metadat_d2preds


ggplot(
  data = metadat_d2preds,
  aes(Duration, pred)
) +
  geom_hline(yintercept = 0) +
  geom_point(aes(fill = Ecosystem_type, colour = Ecosystem_type),
             size = 3, na.rm = TRUE) +
  geom_smooth(method = lm, formula = y ~ x,
              aes(fill = Ecosystem_type, color = Ecosystem_type)) +
  ylab("predicted ln(RR)") +
  scale_x_continuous(
    breaks = seq(0, max(metadat$Duration), 1),
    labels = seq(1, max(metadat$Duration) + 1, 1),
    name = "Study Duration (yrs)"
  ) +
  scale_color_manual(name = "Ecosystem", values = Eco_colors) +
  scale_fill_manual(name = "Ecosystem", values = Eco_colors) +
  theme(legend.position = "bottom")
```
```{r Combined_duration_plot, message = FALSE, warning = FALSE}

#combine predicted dataframes
metadat_d2preds %>%
  mutate(Manipulation = "-P") %>%
    bind_rows(metadat_ipreds2) %>%
  mutate(Manipulation = replace_na(Manipulation, "+P")) -> metadat_bothpreds


ggplot(
  data = metadat_bothpreds,
  aes(Duration, pred)
) +
  geom_hline(yintercept = 0) +
  geom_point(aes(fill = Ecosystem_type, colour = Ecosystem_type),
             size = 3, na.rm = TRUE) +
  geom_smooth(method = lm, formula = y ~ x,
              aes(fill = Ecosystem_type, color = Ecosystem_type)) +
  ylab("predicted ln(RR)") +
  scale_x_continuous(
    breaks = seq(0, max(metadat$Duration), 1),
    labels = seq(1, max(metadat$Duration) + 1, 1),
    name = "Study Duration (yrs)"
  ) +
  facet_wrap(.~Manipulation, ncol = 2) +
  scale_color_manual(name = "Ecosystem", values = Eco_colors) +
  scale_fill_manual(name = "Ecosystem", values = Eco_colors) +
  theme(legend.position = "bottom")

#by study
keep <- unique(metadat_bothpreds[metadat_bothpreds$Duration > 1,]$Study_number)

studies <- subset(metadat_bothpreds,
                  Study_number %in% keep)

ggplot(studies,
       aes(Duration, pred,
           colour = as.character(Study_number))) +
  geom_hline(yintercept = 0) +
  geom_point() + geom_line() +
  facet_grid(Manipulation~Ecosystem_type,
             scales = "free") +
  theme_bw()

```
\
\
The duration of manipulations strongly affected the direction and magnitude of response of soil respiration to precipitation change. If the interaction of ecosystem type and duration are included in the meta-analytical model for decreased precipitation studies, the interaction term is significant for all ecosystems with more than two years worth of data ((Figure \autoref(fig:Supplement_-P_duration_plot). The effect of duration diverges depending on the relative water-limitation of the ecosystem being impacted. In drought simulations, forests, grasslands, and shrublands show weakening of the manipulation effect over time, leading to reversals of the initial effect. In contrast desert ecosystems have increasingly strong responses to manipulations, whether the change be an increase or decrease in precipitation.  
\
\

# Effect of Manipulation Intensity
## Combined
```{r Intensity_effect_both, fig.cap = " Linear regression of manipulation intensity and effect size.", message = FALSE, warning = FALSE}

#exclude outlier manipulation in savanna
ggplot(
  data = metadat,
  aes(Percent_control, yi)
) +
  geom_hline(yintercept = 0) +
  geom_jitter(na.rm = TRUE, aes(color = Ecosystem_type),
             width = 0.5, size = 4) +
  scale_color_manual(name = "Ecosystem",
                     values = Eco_colors) +
  facet_grid(.~Manipulation, scales = "free", labeller = as_labeller(Manip_labs)) +
  geom_smooth(data = metadat[metadat$Percent_control < 390,],
              method = lm, formula = y ~ x) +
  stat_poly_eq(data = metadat[metadat$Percent_control < 390,],
               formula = y ~ x,
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~"))) +
  ylab("ln(RR)") +
  xlab("Percent of MAP") +
  theme(legend.position = "bottom")

```
```{r Intensity_effect_-P, fig.cap = " Supplemental -P predicted effect.", message = FALSE, warning = FALSE}

ggplot(
  data = metadat_d2preds,
  aes(Percent_control, pred)
) +
  geom_hline(yintercept = 0) +
  geom_jitter(na.rm = TRUE, aes(color = Ecosystem_type),
             width = 0.5, size = 4) +
  scale_color_manual(name = "Ecosystem",
                     values = Eco_colors) +
  geom_smooth(method = lm, formula = y ~ x) +
  stat_poly_eq(formula = y ~ x,
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~"))) +
  ylab("predicted ln(RR)") +
  xlab("Percent of MAP") +
  theme(legend.position = "bottom")

```
   
\
\
The intensity of the manipulation ranked with higher importance for -P studies (Figure \autoref(fig:Intensity_effect_both) than +P. The relationship is intuitive: the stronger the decrease in precipitation, the stronger the decrease in soil respiration. While manipulation intensity was not included in the primary model for +P (due to being below the top 4 ranking threshold), If the effect of intensity was included in the +P model, a positive relationship exists, predominantly driven by one very high treatment in a savanna. The slope of this regression line was however still lower than that found in -P.  
\
\

# Soil Content Effects
```{r Ecosystem_type_effect, include = FALSE}

lower_ci <- function(mean, se, n, conf_level = 0.95) {
  lower_ci <- mean - qt(1 - ((1 - conf_level) / 2), n - 1) * se
}
upper_ci <- function(mean, se, n, conf_level = 0.95) {
  upper_ci <- mean + qt(1 - ((1 - conf_level) / 2), n - 1) * se
}

ggplot(Coef_drought, aes(estimate,
                         row.names(Coef_drought),
                         na.rm = TRUE
)) +
  geom_vline(xintercept = 0) +
  geom_errorbarh(aes(
    xmax = estimate + se,
    xmin = estimate - se,
    na.rm = TRUE
  )) +
  geom_point(size = 4, na.rm = TRUE)

ggplot(Coef_irrigation, aes(estimate,
                            row.names(Coef_irrigation),
                            na.rm = TRUE
)) +
  geom_vline(xintercept = 0) +
  geom_errorbarh(aes(
    xmax = estimate + se,
    xmin = estimate - se,
    na.rm = TRUE
  )) +
  geom_point(size = 4, na.rm = TRUE)

metadat %>%
  group_by(Manipulation, Ecosystem_type) %>%
  summarise(
    average = mean(yi, na.rm = TRUE),
    ssd = sd(yi, na.rm = TRUE),
    count = n()
  ) %>%
  mutate(
    se = ssd / sqrt(count),
    lower_ci = lower_ci(average, se, count),
    upper_ci = upper_ci(average, se, count)
  ) -> Ecosystem_effect

ggplot(Ecosystem_effect, aes(average, Ecosystem_type, label = count)) +
  geom_vline(xintercept = 0) +
  geom_errorbarh(aes(
    xmax = upper_ci, xmin = lower_ci,
    na.rm = TRUE
  )) +
  geom_point(size = 4, na.rm = TRUE) +
  facet_grid(. ~ Manipulation) +
  geom_label()
```


```{r Soil_grid_ocs, fig.cap = " Soils with higher organic C content had weaker responses to changes in precipitation.", echo = FALSE, warning = FALSE, message = FALSE}
ocs_preds <- metadat_dpreds %>%
  select(-Percent_control, -sg_clay) %>%
  mutate(Manipulation = "Drought") %>%
  bind_rows(metadat_ipreds)

ocs_preds[is.na(ocs_preds)] <- "Irrigation"

ggplot(
  data = ocs_preds,
  aes(sg_ocs / 10, pred) #convert from t/ha (as stored in soil grids) to kg/m^2
) +
  geom_hline(yintercept = 0) +
  geom_point(aes(fill = Ecosystem_type, colour = Ecosystem_type),
             size = 4, na.rm = TRUE
  ) +
  geom_smooth(method = lm, formula = y ~ x) +
  facet_wrap(~Manipulation, ncol=2, labeller = as_labeller(Manip_labs)) +
  ylab("predicted ln(RR)") +
  xlab(expression(~"Organic Carbon Stock" ~ ("0-30 cm") ~ "kg m"^{
    "-2"
  })) +
  scale_color_manual(name = "Ecosystem",
                     values = Eco_colors) +
    geom_smooth(method = lm, formula = y ~ x) +
  stat_poly_eq(formula = y ~ x,
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~"))) +
  guides(colour = guide_legend(override.aes = list(size = 4))) +
  theme(legend.position = "none")

```

\
\
The organic C content of soil was highly significant for both manipulation types (`r pclean(ocs_dp, 3)` for -P, `r pclean(ocs_ip, 3)` for +P). The overall effect of soil organic C was positive, meaning that soils with more C had higher respiration rates in response to treatments. However, when effect sizes are plotted against organic C stocks (Figure \autoref(fig:Soil_grid_ocs)), we found high SOC was able to reverse the effect of -P treatments, with the predicted effect sizes showing increased rather than decreased respiration rates.
\
\

```{r Soil_grid_clay, fig.cap = " Clay content was not a strong predictor of soil respiration resonse to precipitation change.", echo = FALSE, warning = FALSE}

ggplot(
  data = metadat_dpreds,
  aes(sg_clay / 10, pred) #convert from g/kg (as stored in soil grids) to g/100 g
) +
  geom_hline(yintercept = 0) +
  geom_point(aes(colour = Ecosystem_type),
              width = .15, size = 4) +
  geom_smooth(method = lm, formula = y ~ x) +
  ylab("predicted ln(RR)") +
  xlab("%Clay (15-30 cm)") +
      geom_smooth(method = lm, formula = y ~ x) +
  stat_poly_eq(formula = y ~ x,
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~"))) +
  scale_color_manual(name = "Ecosystem",
                     values = Eco_colors) +
  theme(legend.position = "bottom")
```

```{r Soil_grid_clay_supplement, warning = FALSE}

ggplot(
  data = metadat,
  aes(sg_clay / 10, yi) #convert from g/kg (as stored in soil grids) to g/100 g
) +
  geom_hline(yintercept = 0) +
  geom_jitter(aes(colour = Ecosystem_type),
             width = .15, size = 4) +
  geom_smooth(method = lm, formula = y ~ x) +
  ylab("ln(RR)") +
  facet_wrap(~Manipulation, ncol=2, labeller = as_labeller(Manip_labs)) +
  xlab("%Clay (15-30 cm)") +
      geom_smooth(method = lm, formula = y ~ x) +
  stat_poly_eq(formula = y ~ x,
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~"))) +
  scale_color_manual(name = "Ecosystem",
                     values = Eco_colors) +
  theme(legend.position = "bottom")
```
\
\
Clay had low predictor importance for +P, high for -P. The linear regression between effect sizes and clay content supports this result (Figure \autoref(fig:Soil_grid_clay)). However, the effect was not significant in the deceased precipitation model, and clay content was not of sufficient importance to include in the increased precipitation model.

Clay had low predictor importance for +P and was not included in the primary +P model, but was included as a top four predictor in -P. The linear regression between model-predicted effect sizes and clay content supported this divergence (Figure \autoref(fig:Soil_grid_clay))., with a positive effect of clay content on effect size, resulting in a similar reversal of treatment effect as seen in the SOC result. Despite this, the primary effect of clay was not significant in the -P model and we observed no trend between these variables for +P (Figure \autoref(Soil_grid_clay_supplement)).
\
\
# The End

```{r end}
sessionInfo()
```
